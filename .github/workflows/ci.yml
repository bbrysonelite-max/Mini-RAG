name: Mini-RAG CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.9"
  NODE_VERSION: "20"
  ALLOW_INSECURE_DEFAULTS: "true"

jobs:
  backend:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Dependency audit (pip-audit)
        run: |
          python -m pip install pip-audit
          pip-audit --strict || (pip-audit && exit 1)

      - name: Run unit tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/rag_brain
          STRIPE_API_KEY: sk_test_placeholder
          STRIPE_WEBHOOK_SECRET: whsec_placeholder
          ALLOW_INSECURE_DEFAULTS: "true"
        run: |
          # Use pytest selection to avoid DB-heavy suites unless container is running
          python -m pytest test_quota_service.py test_api_key_auth.py test_billing_guard.py tests/test_api_contract.py

  frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: frontend-react
        run: npm ci

      - name: Build React app
        working-directory: frontend-react
        run: npm run build

